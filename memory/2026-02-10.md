2026-02-10

- 操作摘要（已完成，主控执行）：
  - 将 backfill 脚本强制要求写入 agentId 与 processed_files（防重复）；切片采用 turns-based（7 turns / overlap 3）；summaries 使用 gpt-4o-mini，关键 chunk 升级 gpt-5-mini。脚本位置：memory_system/scripts/backfill_telegram_html.py。
  - 去重策略固化并实施：exact-match 自动合并（保留最新），semantic-match 阈值策略（>=0.96 自动合并；0.92-0.96 标记）。已对历史重复执行一次 exact 合并（删除记录保存于 reports/dedupe_deleted_exact.csv）。
  - 检索顺序固化：agent-scoped summaries -> agent-scoped embeddings -> cold chat_turns（回退）。检索逻辑更新在 memory_system/memory_v1_rag.py。
  - Cron 调度调整：兜底回填改为 01:00/07:00/13:00/19:00（避免与 nightly dedupe 03:00、备份 21:00、每日精炼 23:10 冲突）；Memory 夜间备份（仅 MEMORY.md）保留并已设。回填临时禁用由手动恢复为自动恢复由用户授权。
  - 备份：手动备份 MEMORY.md -> reports/backups/Memery-Main_manual_20260210.tgz（sha256 c3ee0d28...5950）。数据库 pre-dedupe 备份：reports/backups/clawd_db_backup_pre_dedupe_20260210.dump（sha256 a9cf24c8...f5de）。
  - HEARTBEAT 行为调整：保留 heartbeat 检查，但对 long-running 回填增加锁文件机制，避免中途因 heartbeat 变化被强制终止；高费/破坏性步骤仍需 heartbeat=OK 才执行。

- 运维/治理（已写入 ops 文档）：
  - ops_memory_policy.md（中文）与 reports/rag_queries_handbook.md 已更新并保存。
  - 自动去重守护已启用，审计与备份链路已接入（所有自动变更均记录在 reports/）。

- 后续待办（我会继续跟进）：
  - 在 agent 级别把 summaries/embeddings namespace 完整化（agentId 强制字段并在检索时默认过滤）。
  - 做 embeddings-based semantic dedupe 的样本测量（50-100 chunks）并上报实际 token/cost，再决定是否全量运行。
  - 完成 OpenClaw 社区与国际技术站点的调研并汇总可借鉴实践与迁移建议。

- 其他备注：用户指定在出门断网时由用户手动恢复兜底回填（已记录）。

- 当日用户决定：B 类草稿全部不晋升，3 条敏感条目留待人工复核（用户已请求复核）。

- 22:05+ 用户确认执行“记忆系统整理方案 B（标准化）”：
  - 已将专题记忆从 `memory/` 根目录迁移到 `memory/topics/`：
    - `ME_Iran_watch_2026-02-06.md` -> `topics/iran_watch/2026-02-06_iran_watch.md`
    - `VN_realestate_daily_2026-02-06.md` -> `topics/vn_realestate/2026-02-06_vn_realestate.md`
  - 已新增迁移映射：`memory/migrations/2026-02-10_topic_relayout_map.md`
  - 已重建索引：`memory/INDEX.md`（Daily/Topics/Migration 分层）。

- 20260210_220811: 按用户指令清理已废弃本地 sqlite 冷存文件（memory_system/db/memory.db*）。
  - 先备份到：/Users/apple/clawd/reports/backups/deprecated_sqlite_20260210_220811
  - 并生成校验：/Users/apple/clawd/reports/backups/deprecated_sqlite_20260210_220811/SHA256SUMS

- 22:15+ 记忆系统“聊天窗口防溢出”核查结论（长期有效）：
  - 生产主线有效机制为 OpenClaw `compaction.safeguard + memoryFlush`（softThresholdTokens=4000）。
  - `/new` 后连续性保障机制已存在：`library/new_aftercare_checklist.md` + `scripts/aftercare_selfcheck.py`。
  - `longctx` 相关文件当前属于预研/阶段性实现（spec+staging 脚本），未并入当前生产 `openclaw.json` 顶层配置。
  - 运行建议：按阈值触发 `/new`（约 70%+ 或任务阶段切换），避免高频 `/new` 造成效率损失。

- 22:22+ 用户要求产出 longctx 完整开发文档并确认跨 Agent 复用策略。
  - 已新增：`library/specs/longctx_prod_implementation_guide_2026-02-10.md`
  - 结论：核心 longctx 可一次开发、全 Agent 复用；各 Agent 仅需做 agent_id 隔离接入 + 参数继承/覆盖 + 回归验收。

- 22:29+ 按用户授权开始“记忆系统 × longctx 去冲突”试做（首批代码改造）：
  - `memory_system/memory_v1_rag.py`
    - 新增统一摘要写入 API：`write_summary(...)`
    - 新增 compaction 幂等写入：`upsert_compaction_summary(...)`
    - 摘要 metadata 统一：`summary_type/source/request_id/chunk_id`
    - 检索排序调整：优先 compaction summary，再 periodic
  - `scripts/longctx_runtime.py`
    - compaction 写入优先走 `memory_write_summary` 统一接口（失败才回退 sqlite）
    - 审计时间戳改为实时 UTC
  - 已通过语法校验：`python3 -m py_compile`

- 22:38+ 用户要求沉淀“记忆系统+LongCtx”完整开发与说明文档，供其他 Agent 理解与执行。
  - 已新增目录：`library/memory-system/`
  - 已新增文档：README / ARCHITECTURE / DEVELOPER_GUIDE / OPERATIONS_RUNBOOK
  - 已在 `library/INDEX.md` 增加入口索引。

- 22:42+ 用户要求将 LongCtx 灰度扩展到 CTF 小钻（ctf-director）。
  - 已更新：`config/longctx_rollout.json`
  - pilotAgents: `main, news-analyst, ctf-director`

- 22:44-22:47 全员文档宣贯 ACK 收齐（7/7）：ctf-director / vn-realestate / news-analyst / nba-expert / library-keeper / designer / writer-editor。
- 全员共识：Memory=数据层，LongCtx=编排层；统一 API 写入与检索，默认 agent/session 隔离，不建旁路。
- 汇总风险主题：
  1) 记忆碎片化与冗余（检索效率下降）
  2) periodic 与 compaction 重复摘要/幂等风险
  3) 灰度期跨 Agent 串线风险（最高优先级）
  4) 非灰度 Agent 误触发新链路风险（灰度边界）
  5) 设计类抽象创意在压缩中语义损失风险
  6) compaction 摘要质量不足导致“遮蔽高质量原文/periodic”风险
- 治理口径已定：
  - library-keeper 负责审计与上报，不做运行时强制阻断；阻断/降级由主控执行。
